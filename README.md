# ğŸ³ Docker Image Migration Tool

Python tool to migrate Docker images between machines using **disk storage** or **private Docker Registry**. Perfect for environments without direct internet access or with corporate registries.

## âœ¨ Features

- ğŸ“¦ **Two operation modes**: Disk (save/load) or Registry (push/pull)
- ğŸ” **Flexible authentication**: Environment variables, CLI, configuration file
- ğŸ¯ **Smart filtering**: Only built images (`--only-built`) or unchanged (`--skip-unchanged`)
- ğŸ“Š **Metadata tracking**: JSON with IDs, digests and timestamps
- ğŸ”„ **Compose generation**: Creates production-ready docker-compose.yml
- ğŸ¨ **Enhanced UI**: Animated spinners and informative emojis
- ğŸš€ **Auto-detection**: HTTPS/HTTP protocol and existing authentication

## ğŸ“‹ Requirements

- Python 3.7+
- Docker and docker-compose installed
- Libraries: `pyyaml` (installed automatically)

## ğŸš€ Installation

```bash
git clone https://github.com/sudebaker/move_docker_images.git
cd move_docker_images
pip install pyyaml
```

## ğŸ’¡ Quick Start

### Disk Mode (without registry)

```bash
# Save images to disk
python move_images.py save \
  --docker-compose docker-compose.yml \
  --output-dir /path/to/images

# Load images from disk
python move_images.py load \
  --output-dir /path/to/images
```

### Registry Mode

```bash
# Push to private registry
python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-config registry_config.json

# Pull from registry
python move_images.py pull \
  --registry-config registry_config.json
```

## ğŸ”§ Registry Configuration

Create a `registry_config.json` file (see `registry_config.json.example`):

## ğŸ”§ ConfiguraciÃ³n del Registry

Crea un archivo `registry_config.json` (ver `registry_config.json.example`):

```json
{
  "registry_url": "registry.example.com",
  "username": "your_user",
  "password": "your_password",
  "prefix": "projects",
  "insecure": false,
  "auto_logout": false
}
```

**âš ï¸ Important**: This file contains credentials. The script automatically sets `chmod 600` permissions.

## ğŸ“š Usage Examples

### 1. Push only locally built images

```bash
python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-url registry.mycompany.com \
  --registry-prefix projects \
  --only-built
```

### 2. Push with skip-unchanged (incremental)

```bash
python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-config registry_config.json \
  --skip-unchanged
```

### 3. Push and generate docker-compose for productionon

```bash
python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-config registry_config.json \
  --generate-compose docker-compose.registry.yml \
  --only-built
```

This generates a new compose with registry images:

```yaml
# Auto-generated by move_images.py
# Date: 2025-11-24 10:30:00 UTC
# Registry: registry.example.com
# Modified services: frontend, api, worker

services:
  frontend:
    image: registry.example.com/projects/myapp/frontend:latest
    # build: removed
    ports:
      - "3000:3000"
```

### 4. Pull from metadata

```bash
python move_images.py pull \
  --registry-config registry_config.json \
  --metadata-file image_metadata.json
```

### 5. Authentication with environment variables

```bash
export REGISTRY_USER=myuser
export REGISTRY_PASSWORD=mypassword

python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-url registry.mycompany.com
```

## ğŸ¯ Main Options

### Actions
- `save` - Save images to disk (tar)
- `load` - Load images from disk
- `push` - Upload images to registry
- `pull` - Download images from registry

### Common Arguments
- `--docker-compose` - Path to docker-compose.yml (default: `./docker-compose.yml`)
- `--output-dir` - Directory for save/load (default: `./docker_images`)
- `--skip-unchanged` - Don't reprocess unchanged images
- `--only-built` - Only services with `build:` in compose
- `--metadata-file` - JSON file with metadata (default: `output-dir/image_metadata.json`)
- `--timeout` - Timeout in seconds (default: 600)

### Registry Options
- `--registry-url` - Registry URL (e.g., `registry.example.com`)
- `--registry-prefix` - Prefix/namespace (e.g., `projects`)
- `--registry-user` - User for authentication
- `--registry-password` - Password (prefer env vars)
- `--registry-config` - JSON file with configuration
- `--skip-login` - Don't attempt login (assume authenticated)
- `--auto-logout` - Logout when finished
- `--generate-compose` - Generate docker-compose.yml for registry

## ğŸ” Authentication Strategies

The script attempts authentication in this order:

1. **Existing login** - Checks `~/.docker/config.json`
2. **Environment variables** - `REGISTRY_USER` and `REGISTRY_PASSWORD`
3. **Configuration file** - `registry_config.json`
4. **CLI arguments** - `--registry-user` and `--registry-password`
5. **Public test** - Attempts pull without auth
6. **Error** - Requests credentials

## ğŸ“Š Metadata Tracking

The `image_metadata.json` file stores:

```json
{
  "images": {
    "myapp/frontend": {
      "image_id": "sha256:abc123...",
      "registry_tag": "registry.com/myapp/frontend:latest",
      "digest": "sha256:def456...",
      "pushed_at": "2025-11-24T10:30:00Z",
      "service_name": "frontend"
    }
  },
  "last_updated": "2025-11-24T10:30:00Z"
}
```

This enables:
- âœ… Skip-unchanged: Detect unchanged images
- âœ… Selective pull: Download only necessary ones
- âœ… Tracking: Version audit trail

## ğŸŒ Complete CI/CD Workflow

```bash
#!/bin/bash
# deploy.sh

# 1. Local build (already done with docker-compose build)

# 2. Push to registry and generate compose
python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-config registry_config.json \
  --generate-compose docker-compose.registry.yml \
  --only-built \
  --skip-unchanged

# 3. Commit generated compose
git add docker-compose.registry.yml
git commit -m "Update registry compose [skip ci]"
git push

# 4. Deploy to production
scp docker-compose.registry.yml prod-server:/app/
ssh prod-server "cd /app && docker-compose -f docker-compose.registry.yml pull && docker-compose -f docker-compose.registry.yml up -d"

echo "âœ… Deployment completed"
```

## ğŸ” Use Cases

### 1. Offline Environment
Ideal for migrating images to servers without Docker Hub access:
```bash
# On machine with internet
python move_images.py save --docker-compose docker-compose.yml --output-dir /usb/images

# On offline server
python move_images.py load --output-dir /usb/images
```

### 2. Corporate Registry
Organize images in private registry with namespaces:
```bash
python move_images.py push \
  --docker-compose docker-compose.yml \
  --registry-url registry.company.com \
  --registry-prefix my-project \
  --only-built
```

### 3. Multi-Environment Deployment
Generate environment-specific composes for dev/staging/prod:ing/prod:
```bash
# Staging
python move_images.py push \
  --registry-config staging-registry.json \
  --generate-compose docker-compose.staging.yml

# Production
python move_images.py push \
  --registry-config prod-registry.json \
  --generate-compose docker-compose.prod.yml
```

## ğŸ› Troubleshooting

### Error: "no space left on device"
Docker temporarily saves in `/tmp`. Solutions:
```bash
# Change TMPDIR
export TMPDIR=/path/to/large/disk
python move_images.py save ...

# Or use registry mode
python move_images.py push ...
```

### Error: "unauthorized: authentication required"
Verify credentials and URL:
```bash
# Manual test
docker login registry.example.com -u user -p password

# With the script
python move_images.py push --registry-url registry.example.com --skip-login
```

### Error: "manifest unknown"
The image doesn't exist in the registry. Verify the tag:
```bash
# List available tags
curl -X GET https://registry.com/v2/namespace/image/tags/list
```

## ğŸ“ Project Structure

```
.
â”œâ”€â”€ move_images.py                      # Main script
â”œâ”€â”€ registry_config.json.example        # Configuration template
â””â”€â”€ README.md                           # This file
```

## ğŸ¤ Contributing

1. Fork the project
2. Create a feature branch (`git checkout -b feature/new-feature`)
3. Commit your changes (`git commit -am 'Add new feature'`)
4. Push to the branch (`git push origin feature/new-feature`)
5. Open a Pull Request

## ğŸ“ License

MIT License - see LICENSE file for details

## ğŸ™ Acknowledgments

Developed to facilitate Docker image management in enterprise environments with private registries and connectivity restrictions.

## ğŸ“ Support

To report bugs or request features, open an issue on GitHub.

---

**Note**: This project was created to solve real Docker image migration problems in corporate environments. If you find it useful, give it a â­ on GitHub!
